import{u as Z}from"./index-CXwOSWS5.js";import{y as h,J as D,A as l,P as E,G as B,ay as $,M as N,O as R,a6 as z,H as _,a4 as ee,D as L,r as w,X as te,j as se,h as ae,n as T,ag as oe,z as c,L as U}from"./vue-c0ldzDov.js";import{_ as ne,u as re}from"./index-DBuZOtR4.js";import{w as ie,x as le,v as G,s as ce,y as de,z as ue,A as me,d as ge,c as he,r as pe}from"./element-plus-DlfEvqLm.js";const j="forest_economy_chat_history",Q=Date.now().toString(),ve=3,fe={name:"ForestEconomyMainContent",components:{},setup(){const A=re(),a=Z(),I=w(""),t=w(!1),n=w([]),M=w(!1),f=w(null),k=w(0),m=w(""),p=w(Q),v=te({show:!1,title:"",message:"",type:"error"}),O=["æ—ä¸‹ç»æµæœ‰å“ªäº›ä¸»è¦ç±»å‹ï¼Ÿ","å¦‚ä½•è¯„ä¼°æ—ä¸‹ç§æ¤çš„ç»æµæ•ˆç›Šï¼Ÿ","æ—ä¸‹å…»èœ‚çš„æœ€ä½³å®è·µæ˜¯ä»€ä¹ˆï¼Ÿ","æ—ä¸‹é£Ÿç”¨èŒåŸ¹è‚²çš„ç¯å¢ƒè¦æ±‚æœ‰å“ªäº›ï¼Ÿ"],y={apiKey:"xai-pJiv7oYrUMGpVcEdjxHJXUGNSrW99u0SqlWHr30ZW816D8bFvAOu3Ige8fZNbq1U9gbPySJMCmxpE3qQ",apiEndpoint:"https://api.x.ai/v1/chat/completions",model:"grok-3-beta"};se(()=>A.query,e=>{if(e.new)x(),p.value=Date.now().toString(),m.value="";else if(e.historyId){const s=a.chatHistory.find(o=>o.id===e.historyId);s&&X(s)}},{immediate:!0}),ae(()=>{!A.query.new&&!A.query.historyId&&r(),n.value.length>0&&T(()=>{S()})});const r=()=>{try{const e=localStorage.getItem(j);if(e){const s=JSON.parse(e);s.messages&&s.title?(n.value=s.messages,m.value=s.title,p.value=s.id||Q):Array.isArray(s)&&(n.value=s)}}catch(e){console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:",e),G.warning("å†å²è®°å½•åŠ è½½å¤±è´¥ï¼Œå°†å¼€å§‹æ–°çš„å¯¹è¯")}},g=()=>{try{localStorage.setItem(j,JSON.stringify({messages:n.value,title:m.value,id:p.value})),m.value&&n.value.length>0&&a.addHistory({id:p.value,title:m.value,timestamp:Date.now(),messages:n.value})}catch(e){console.error("ä¿å­˜å†å²è®°å½•å¤±è´¥:",e),G.warning("å†å²è®°å½•ä¿å­˜å¤±è´¥")}},x=()=>{n.value=[],localStorage.removeItem(j),M.value=!1,m.value=""},X=e=>{x(),p.value=e.id,m.value=e.title,e.messages&&e.messages.length>0?(n.value=e.messages,g()):e.firstMessage&&F(e.firstMessage)},F=async e=>{n.value.push({type:"user",content:e,timestamp:Date.now()}),g(),T(()=>{S()}),t.value=!0,k.value=0;try{const s=await P(e);console.log("APIå“åº”æˆåŠŸ:",s),n.value.push({type:"ai",content:V(s),timestamp:Date.now()}),g(),v.show=!1}catch(s){b(s,e)}finally{t.value=!1,T(()=>{S()})}},q=async()=>{if(!I.value.trim())return;const e=I.value.trim();I.value="",n.value.push({type:"user",content:e,timestamp:Date.now()}),g(),T(()=>{S()}),t.value=!0,k.value=0;try{n.value.length===1&&W(e);const s=await P(e);n.value.push({type:"ai",content:V(s),timestamp:Date.now()}),g(),v.show=!1}catch(s){b(s,e)}finally{t.value=!1,T(()=>{S()})}},W=async e=>{var s,o,d,C;try{const i={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y.apiKey}`},body:JSON.stringify({model:y.model,messages:[{role:"user",content:`æ ¹æ®ä»¥ä¸‹é—®é¢˜ç”Ÿæˆä¸€ä¸ªç®€çŸ­çš„æ ‡é¢˜ï¼ˆä¸è¶…è¿‡15ä¸ªå­—ï¼‰ï¼š"${e}"`}],temperature:.7,max_tokens:50})},H=await fetch(y.apiEndpoint,i);if(!H.ok)throw new Error(`æ ‡é¢˜ç”ŸæˆAPIé”™è¯¯: ${H.status}`);let u=(C=(d=(o=(s=(await H.json()).choices)==null?void 0:s[0])==null?void 0:o.message)==null?void 0:d.content)==null?void 0:C.trim();u&&u.length>15&&(u=u.substring(0,15)+"..."),u=u.replace(/["']/g,""),m.value=u,console.log("ç”Ÿæˆçš„å¯¹è¯æ ‡é¢˜:",u),a.addHistory({id:p.value,title:u,timestamp:Date.now(),firstMessage:e})}catch(i){console.error("ç”Ÿæˆæ ‡é¢˜å¤±è´¥:",i);const H=e.length>10?e.substring(0,10)+"...":e;m.value=H,a.addHistory({id:p.value,title:H,timestamp:Date.now(),firstMessage:e})}},P=async e=>{var o,d,C;const s={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y.apiKey}`},body:JSON.stringify({model:y.model,messages:[{role:"user",content:e}],temperature:.7,max_tokens:800})};try{const i=await fetch(y.apiEndpoint,s);if(!i.ok){let u="";try{const K=await i.json();u=JSON.stringify(K)}catch{u="æ— æ³•è§£æé”™è¯¯è¯¦æƒ…"}throw new Error(`APIé”™è¯¯: ${i.status} ${i.statusText}. è¯¦æƒ…: ${u}`)}const J=(C=(d=(o=(await i.json()).choices)==null?void 0:o[0])==null?void 0:d.message)==null?void 0:C.content;return J||"æœªèƒ½ä»APIå“åº”ä¸­è·å–åˆ°å›ç­”"}catch(i){throw(i.name==="AbortError"||i.message.includes("network")||i.message.includes("timeout"))&&(i.isNetworkError=!0),i}},b=async(e,s)=>{if((e.isNetworkError||e.message.includes("network")||e.message.includes("timeout"))&&k.value<ve){k.value++,n.value.push({type:"system",content:`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨è¿›è¡Œç¬¬${k.value}æ¬¡é‡è¯•...`,timestamp:Date.now()}),g(),T(()=>{S()}),await new Promise(o=>setTimeout(o,1e3)),t.value=!0;try{const o=await P(s);n.value=n.value.filter(d=>d.type!=="system"),n.value.push({type:"ai",content:V(o),timestamp:Date.now()}),g(),v.show=!1}catch(o){b(o,s)}finally{t.value=!1}}else{let o="æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚",d="è¯·æ±‚å¤±è´¥";e.isNetworkError||e.message.includes("network")?(d="ç½‘ç»œè¿æ¥é”™è¯¯",o+="è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å¹¶ç¨åå†è¯•ã€‚"):e.message.includes("timeout")?(d="è¯·æ±‚è¶…æ—¶",o+="æœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åå†è¯•ã€‚"):e.message.includes("401")?(d="èº«ä»½éªŒè¯å¤±è´¥",o+="è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆã€‚"):e.message.includes("429")?(d="è¯·æ±‚è¿‡äºé¢‘ç¹",o+="å·²è¶…è¿‡APIä½¿ç”¨é™åˆ¶ï¼Œè¯·ç¨åå†è¯•ã€‚"):e.message.includes("500")&&(d="æœåŠ¡å™¨é”™è¯¯",o+="æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚");const C=`æŠ€æœ¯è¯¦æƒ…: ${e.message}`;v.title=d,v.message=`${o} (${C})`,v.show=!0,n.value.push({type:"ai",content:o,timestamp:Date.now(),isError:!0}),g()}},V=e=>e.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/\n/g,"<br>"),Y=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),S=()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)};return{userInput:I,isLoading:t,chatHistory:n,suggestedQuestions:O,errorInfo:v,showClearHistoryDialog:M,chatMessagesContainer:f,conversationTitle:m,Delete:ue,ArrowUp:de,Search:ce,sendMessage:q,clearChatHistory:x,formatTime:Y,usePresetQuestion:e=>{I.value=e,q()}}}},ye={key:0,class:"conversation-title"},_e={class:"search-title"},we={key:0},ke={key:1},Ce={key:1,class:"chat-container"},He={class:"chat-messages",ref:"chatMessagesContainer"},Ie={class:"message-content"},Se={class:"message-avatar"},De={key:0},Ee={key:1},Te=["innerHTML"],Ae={class:"message-time"},xe={key:2,class:"loading-indicator"},Ne={key:3,class:"suggested-searches"},Me={class:"suggested-items"},Oe={class:"dialog-footer"};function Pe(A,a,I,t,n,M){const f=he,k=oe("Right"),m=ge,p=ie,v=pe,O=le,y=me;return c(),h("div",{class:L(["search-content",{"chat-history-active":t.chatHistory.length>0}])},[t.chatHistory.length>0&&t.conversationTitle?(c(),h("div",ye,N(t.conversationTitle),1)):D("",!0),l("div",_e,[t.conversationTitle?(c(),h("h1",ke,N(t.conversationTitle),1)):(c(),h("h1",we,"æ‚¨æƒ³äº†è§£å“ªäº›æ—ä¸‹ç»æµçŸ¥è¯†ï¼Ÿ"))]),t.chatHistory.length>0?(c(),h("div",Ce,[l("div",He,[(c(!0),h(R,null,z(t.chatHistory,(r,g)=>(c(),h("div",{key:g,class:L(["chat-message",r.type==="user"?"user-message":"ai-message"])},[l("div",Ie,[l("div",Se,[r.type==="user"?(c(),h("span",De,"ğŸ‘¤")):(c(),h("span",Ee,"ğŸŒ³"))]),l("div",{class:"message-text",innerHTML:r.content},null,8,Te)]),l("div",Ae,N(t.formatTime(r.timestamp)),1)],2))),128))],512)])):D("",!0),t.isLoading?(c(),h("div",xe,a[4]||(a[4]=[l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-text"},"æ­£åœ¨æ€è€ƒä¸­...",-1)]))):D("",!0),l("div",{class:L(["search-container",{"search-minimized":t.chatHistory.length>0}])},[E(p,{modelValue:t.userInput,"onUpdate:modelValue":a[0]||(a[0]=r=>t.userInput=r),class:"search-input-el",placeholder:t.chatHistory.length>0?"ç»§ç»­æé—®...":"éšæ„æé—®...",onKeyup:ee(t.sendMessage,["enter"])},{append:_(()=>[E(f,{type:"primary",icon:t.chatHistory.length>0?"ArrowUp":"Search",onClick:t.sendMessage,disabled:t.isLoading||t.userInput.trim()===""},null,8,["icon","onClick","disabled"])]),suffix:_(()=>[t.userInput.trim().length>0?(c(),B(m,{key:0,class:"input-icon"},{default:_(()=>[E(k)]),_:1})):D("",!0)]),_:1},8,["modelValue","placeholder","onKeyup"])],2),t.chatHistory.length===0?(c(),h("div",Ne,[a[5]||(a[5]=l("h3",null,"çƒ­é—¨é—®é¢˜",-1)),l("div",Me,[(c(!0),h(R,null,z(t.suggestedQuestions,(r,g)=>(c(),B(v,{key:g,class:"suggested-item-card",shadow:"hover",onClick:x=>t.usePresetQuestion(r)},{default:_(()=>[U(N(r),1)]),_:2},1032,["onClick"]))),128))])])):D("",!0),E(O,{modelValue:t.showClearHistoryDialog,"onUpdate:modelValue":a[2]||(a[2]=r=>t.showClearHistoryDialog=r),title:"æ¸…é™¤å†å²è®°å½•",width:"30%","align-center":""},{footer:_(()=>[l("span",Oe,[E(f,{onClick:a[1]||(a[1]=r=>t.showClearHistoryDialog=!1)},{default:_(()=>a[6]||(a[6]=[U("å–æ¶ˆ")])),_:1}),E(f,{type:"danger",onClick:t.clearChatHistory},{default:_(()=>a[7]||(a[7]=[U("ç¡®å®šæ¸…é™¤")])),_:1},8,["onClick"])])]),default:_(()=>[a[8]||(a[8]=l("span",null,"ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",-1))]),_:1},8,["modelValue"]),t.errorInfo.show?(c(),B(y,{key:4,title:t.errorInfo.title,description:t.errorInfo.message,type:"error","show-icon":"",class:"error-alert",onClose:a[3]||(a[3]=r=>t.errorInfo.show=!1)},null,8,["title","description"])):D("",!0),a[9]||(a[9]=$('<div class="footer" data-v-ae867e7a><div class="footer-links" data-v-ae867e7a><a href="#" class="footer-link" data-v-ae867e7a>å…³äºæˆ‘ä»¬</a><a href="#" class="footer-link" data-v-ae867e7a>è”ç³»æ–¹å¼</a><a href="#" class="footer-link" data-v-ae867e7a>ä½¿ç”¨æ¡æ¬¾</a><a href="#" class="footer-link" data-v-ae867e7a>éšç§æ”¿ç­–</a></div><div class="copyright" data-v-ae867e7a> Â© 2025 æ—ä¸‹ç»æµç ”ç©¶ä¸­å¿ƒ </div></div>',1))],2)}const Ue=ne(fe,[["render",Pe],["__scopeId","data-v-ae867e7a"]]);export{Ue as default};
