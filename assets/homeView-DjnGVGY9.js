import{u as Z}from"./index-CXwOSWS5.js";import{y as h,J as D,A as l,P as E,G as B,ay as $,M as N,O as R,a6 as z,H as _,a4 as ee,D as L,r as w,X as te,j as se,h as ae,n as T,ag as oe,z as c,L as U}from"./vue-c0ldzDov.js";import{_ as ne,u as re}from"./index-DBuZOtR4.js";import{w as ie,x as le,v as G,s as ce,y as de,z as ue,A as me,d as ge,c as he,r as pe}from"./element-plus-DlfEvqLm.js";const j="forest_economy_chat_history",Q=Date.now().toString(),ve=3,fe={name:"ForestEconomyMainContent",components:{},setup(){const A=re(),a=Z(),I=w(""),t=w(!1),n=w([]),M=w(!1),f=w(null),k=w(0),m=w(""),p=w(Q),v=te({show:!1,title:"",message:"",type:"error"}),O=["林下经济有哪些主要类型？","如何评估林下种植的经济效益？","林下养蜂的最佳实践是什么？","林下食用菌培育的环境要求有哪些？"],y={apiKey:"xai-pJiv7oYrUMGpVcEdjxHJXUGNSrW99u0SqlWHr30ZW816D8bFvAOu3Ige8fZNbq1U9gbPySJMCmxpE3qQ",apiEndpoint:"https://api.x.ai/v1/chat/completions",model:"grok-3-beta"};se(()=>A.query,e=>{if(e.new)x(),p.value=Date.now().toString(),m.value="";else if(e.historyId){const s=a.chatHistory.find(o=>o.id===e.historyId);s&&X(s)}},{immediate:!0}),ae(()=>{!A.query.new&&!A.query.historyId&&r(),n.value.length>0&&T(()=>{S()})});const r=()=>{try{const e=localStorage.getItem(j);if(e){const s=JSON.parse(e);s.messages&&s.title?(n.value=s.messages,m.value=s.title,p.value=s.id||Q):Array.isArray(s)&&(n.value=s)}}catch(e){console.error("加载历史记录失败:",e),G.warning("历史记录加载失败，将开始新的对话")}},g=()=>{try{localStorage.setItem(j,JSON.stringify({messages:n.value,title:m.value,id:p.value})),m.value&&n.value.length>0&&a.addHistory({id:p.value,title:m.value,timestamp:Date.now(),messages:n.value})}catch(e){console.error("保存历史记录失败:",e),G.warning("历史记录保存失败")}},x=()=>{n.value=[],localStorage.removeItem(j),M.value=!1,m.value=""},X=e=>{x(),p.value=e.id,m.value=e.title,e.messages&&e.messages.length>0?(n.value=e.messages,g()):e.firstMessage&&F(e.firstMessage)},F=async e=>{n.value.push({type:"user",content:e,timestamp:Date.now()}),g(),T(()=>{S()}),t.value=!0,k.value=0;try{const s=await P(e);console.log("API响应成功:",s),n.value.push({type:"ai",content:V(s),timestamp:Date.now()}),g(),v.show=!1}catch(s){b(s,e)}finally{t.value=!1,T(()=>{S()})}},q=async()=>{if(!I.value.trim())return;const e=I.value.trim();I.value="",n.value.push({type:"user",content:e,timestamp:Date.now()}),g(),T(()=>{S()}),t.value=!0,k.value=0;try{n.value.length===1&&W(e);const s=await P(e);n.value.push({type:"ai",content:V(s),timestamp:Date.now()}),g(),v.show=!1}catch(s){b(s,e)}finally{t.value=!1,T(()=>{S()})}},W=async e=>{var s,o,d,C;try{const i={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y.apiKey}`},body:JSON.stringify({model:y.model,messages:[{role:"user",content:`根据以下问题生成一个简短的标题（不超过15个字）："${e}"`}],temperature:.7,max_tokens:50})},H=await fetch(y.apiEndpoint,i);if(!H.ok)throw new Error(`标题生成API错误: ${H.status}`);let u=(C=(d=(o=(s=(await H.json()).choices)==null?void 0:s[0])==null?void 0:o.message)==null?void 0:d.content)==null?void 0:C.trim();u&&u.length>15&&(u=u.substring(0,15)+"..."),u=u.replace(/["']/g,""),m.value=u,console.log("生成的对话标题:",u),a.addHistory({id:p.value,title:u,timestamp:Date.now(),firstMessage:e})}catch(i){console.error("生成标题失败:",i);const H=e.length>10?e.substring(0,10)+"...":e;m.value=H,a.addHistory({id:p.value,title:H,timestamp:Date.now(),firstMessage:e})}},P=async e=>{var o,d,C;const s={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y.apiKey}`},body:JSON.stringify({model:y.model,messages:[{role:"user",content:e}],temperature:.7,max_tokens:800})};try{const i=await fetch(y.apiEndpoint,s);if(!i.ok){let u="";try{const K=await i.json();u=JSON.stringify(K)}catch{u="无法解析错误详情"}throw new Error(`API错误: ${i.status} ${i.statusText}. 详情: ${u}`)}const J=(C=(d=(o=(await i.json()).choices)==null?void 0:o[0])==null?void 0:d.message)==null?void 0:C.content;return J||"未能从API响应中获取到回答"}catch(i){throw(i.name==="AbortError"||i.message.includes("network")||i.message.includes("timeout"))&&(i.isNetworkError=!0),i}},b=async(e,s)=>{if((e.isNetworkError||e.message.includes("network")||e.message.includes("timeout"))&&k.value<ve){k.value++,n.value.push({type:"system",content:`网络请求失败，正在进行第${k.value}次重试...`,timestamp:Date.now()}),g(),T(()=>{S()}),await new Promise(o=>setTimeout(o,1e3)),t.value=!0;try{const o=await P(s);n.value=n.value.filter(d=>d.type!=="system"),n.value.push({type:"ai",content:V(o),timestamp:Date.now()}),g(),v.show=!1}catch(o){b(o,s)}finally{t.value=!1}}else{let o="抱歉，我暂时无法回答您的问题。",d="请求失败";e.isNetworkError||e.message.includes("network")?(d="网络连接错误",o+="请检查您的网络连接并稍后再试。"):e.message.includes("timeout")?(d="请求超时",o+="服务器响应时间过长，请稍后再试。"):e.message.includes("401")?(d="身份验证失败",o+="请联系管理员检查API密钥是否有效。"):e.message.includes("429")?(d="请求过于频繁",o+="已超过API使用限制，请稍后再试。"):e.message.includes("500")&&(d="服务器错误",o+="服务器内部错误，请稍后再试。");const C=`技术详情: ${e.message}`;v.title=d,v.message=`${o} (${C})`,v.show=!0,n.value.push({type:"ai",content:o,timestamp:Date.now(),isError:!0}),g()}},V=e=>e.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/\n/g,"<br>"),Y=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),S=()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)};return{userInput:I,isLoading:t,chatHistory:n,suggestedQuestions:O,errorInfo:v,showClearHistoryDialog:M,chatMessagesContainer:f,conversationTitle:m,Delete:ue,ArrowUp:de,Search:ce,sendMessage:q,clearChatHistory:x,formatTime:Y,usePresetQuestion:e=>{I.value=e,q()}}}},ye={key:0,class:"conversation-title"},_e={class:"search-title"},we={key:0},ke={key:1},Ce={key:1,class:"chat-container"},He={class:"chat-messages",ref:"chatMessagesContainer"},Ie={class:"message-content"},Se={class:"message-avatar"},De={key:0},Ee={key:1},Te=["innerHTML"],Ae={class:"message-time"},xe={key:2,class:"loading-indicator"},Ne={key:3,class:"suggested-searches"},Me={class:"suggested-items"},Oe={class:"dialog-footer"};function Pe(A,a,I,t,n,M){const f=he,k=oe("Right"),m=ge,p=ie,v=pe,O=le,y=me;return c(),h("div",{class:L(["search-content",{"chat-history-active":t.chatHistory.length>0}])},[t.chatHistory.length>0&&t.conversationTitle?(c(),h("div",ye,N(t.conversationTitle),1)):D("",!0),l("div",_e,[t.conversationTitle?(c(),h("h1",ke,N(t.conversationTitle),1)):(c(),h("h1",we,"您想了解哪些林下经济知识？"))]),t.chatHistory.length>0?(c(),h("div",Ce,[l("div",He,[(c(!0),h(R,null,z(t.chatHistory,(r,g)=>(c(),h("div",{key:g,class:L(["chat-message",r.type==="user"?"user-message":"ai-message"])},[l("div",Ie,[l("div",Se,[r.type==="user"?(c(),h("span",De,"👤")):(c(),h("span",Ee,"🌳"))]),l("div",{class:"message-text",innerHTML:r.content},null,8,Te)]),l("div",Ae,N(t.formatTime(r.timestamp)),1)],2))),128))],512)])):D("",!0),t.isLoading?(c(),h("div",xe,a[4]||(a[4]=[l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-text"},"正在思考中...",-1)]))):D("",!0),l("div",{class:L(["search-container",{"search-minimized":t.chatHistory.length>0}])},[E(p,{modelValue:t.userInput,"onUpdate:modelValue":a[0]||(a[0]=r=>t.userInput=r),class:"search-input-el",placeholder:t.chatHistory.length>0?"继续提问...":"随意提问...",onKeyup:ee(t.sendMessage,["enter"])},{append:_(()=>[E(f,{type:"primary",icon:t.chatHistory.length>0?"ArrowUp":"Search",onClick:t.sendMessage,disabled:t.isLoading||t.userInput.trim()===""},null,8,["icon","onClick","disabled"])]),suffix:_(()=>[t.userInput.trim().length>0?(c(),B(m,{key:0,class:"input-icon"},{default:_(()=>[E(k)]),_:1})):D("",!0)]),_:1},8,["modelValue","placeholder","onKeyup"])],2),t.chatHistory.length===0?(c(),h("div",Ne,[a[5]||(a[5]=l("h3",null,"热门问题",-1)),l("div",Me,[(c(!0),h(R,null,z(t.suggestedQuestions,(r,g)=>(c(),B(v,{key:g,class:"suggested-item-card",shadow:"hover",onClick:x=>t.usePresetQuestion(r)},{default:_(()=>[U(N(r),1)]),_:2},1032,["onClick"]))),128))])])):D("",!0),E(O,{modelValue:t.showClearHistoryDialog,"onUpdate:modelValue":a[2]||(a[2]=r=>t.showClearHistoryDialog=r),title:"清除历史记录",width:"30%","align-center":""},{footer:_(()=>[l("span",Oe,[E(f,{onClick:a[1]||(a[1]=r=>t.showClearHistoryDialog=!1)},{default:_(()=>a[6]||(a[6]=[U("取消")])),_:1}),E(f,{type:"danger",onClick:t.clearChatHistory},{default:_(()=>a[7]||(a[7]=[U("确定清除")])),_:1},8,["onClick"])])]),default:_(()=>[a[8]||(a[8]=l("span",null,"确定要清除所有聊天历史记录吗？此操作无法撤销。",-1))]),_:1},8,["modelValue"]),t.errorInfo.show?(c(),B(y,{key:4,title:t.errorInfo.title,description:t.errorInfo.message,type:"error","show-icon":"",class:"error-alert",onClose:a[3]||(a[3]=r=>t.errorInfo.show=!1)},null,8,["title","description"])):D("",!0),a[9]||(a[9]=$('<div class="footer" data-v-ae867e7a><div class="footer-links" data-v-ae867e7a><a href="#" class="footer-link" data-v-ae867e7a>关于我们</a><a href="#" class="footer-link" data-v-ae867e7a>联系方式</a><a href="#" class="footer-link" data-v-ae867e7a>使用条款</a><a href="#" class="footer-link" data-v-ae867e7a>隐私政策</a></div><div class="copyright" data-v-ae867e7a> © 2025 林下经济研究中心 </div></div>',1))],2)}const Ue=ne(fe,[["render",Pe],["__scopeId","data-v-ae867e7a"]]);export{Ue as default};
