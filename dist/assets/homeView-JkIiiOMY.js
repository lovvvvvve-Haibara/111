import{u as Z}from"./index-BqCzZp7W.js";import{_ as $,j as h,k as E,i as l,f as T,a as U,Q as ee,J as x,G as L,H as Q,w as _,R as te,S as se,n as B,T as ae,r as w,U as oe,V as ne,o as ie,u as re,W as D,P as z,F as le,X as ce,Y as de,Z as ue,d as me,e as c,m as ge,l as he,y as R,M as pe}from"./index-qPLI_qMi.js";const j="forest_economy_chat_history",F=Date.now().toString(),ve=3,fe={name:"ForestEconomyMainContent",components:{},setup(){const A=re(),a=Z(),S=w(""),t=w(!1),n=w([]),M=w(!1),f=w(null),k=w(0),m=w(""),p=w(F),v=oe({show:!1,title:"",message:"",type:"error"}),P=["林下经济有哪些主要类型？","如何评估林下种植的经济效益？","林下养蜂的最佳实践是什么？","林下食用菌培育的环境要求有哪些？"],y={apiKey:"xai-pJiv7oYrUMGpVcEdjxHJXUGNSrW99u0SqlWHr30ZW816D8bFvAOu3Ige8fZNbq1U9gbPySJMCmxpE3qQ",apiEndpoint:"https://api.x.ai/v1/chat/completions",model:"grok-3-beta"};ne(()=>A.query,e=>{if(e.new)N(),p.value=Date.now().toString(),m.value="";else if(e.historyId){const s=a.chatHistory.find(o=>o.id===e.historyId);s&&G(s)}},{immediate:!0}),ie(()=>{!A.query.new&&!A.query.historyId&&i(),n.value.length>0&&D(()=>{I()})});const i=()=>{try{const e=localStorage.getItem(j);if(e){const s=JSON.parse(e);s.messages&&s.title?(n.value=s.messages,m.value=s.title,p.value=s.id||F):Array.isArray(s)&&(n.value=s)}}catch(e){console.error("加载历史记录失败:",e),z.warning("历史记录加载失败，将开始新的对话")}},g=()=>{try{localStorage.setItem(j,JSON.stringify({messages:n.value,title:m.value,id:p.value})),m.value&&n.value.length>0&&a.addHistory({id:p.value,title:m.value,timestamp:Date.now(),messages:n.value})}catch(e){console.error("保存历史记录失败:",e),z.warning("历史记录保存失败")}},N=()=>{n.value=[],localStorage.removeItem(j),M.value=!1,m.value=""},G=e=>{N(),p.value=e.id,m.value=e.title,e.messages&&e.messages.length>0?(n.value=e.messages,g()):e.firstMessage&&W(e.firstMessage)},W=async e=>{n.value.push({type:"user",content:e,timestamp:Date.now()}),g(),D(()=>{I()}),t.value=!0,k.value=0;try{const s=await V(e);console.log("API响应成功:",s),n.value.push({type:"ai",content:O(s),timestamp:Date.now()}),g(),v.show=!1}catch(s){b(s,e)}finally{t.value=!1,D(()=>{I()})}},q=async()=>{if(!S.value.trim())return;const e=S.value.trim();S.value="",n.value.push({type:"user",content:e,timestamp:Date.now()}),g(),D(()=>{I()}),t.value=!0,k.value=0;try{n.value.length===1&&X(e);const s=await V(e);n.value.push({type:"ai",content:O(s),timestamp:Date.now()}),g(),v.show=!1}catch(s){b(s,e)}finally{t.value=!1,D(()=>{I()})}},X=async e=>{var s,o,d,C;try{const r={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y.apiKey}`},body:JSON.stringify({model:y.model,messages:[{role:"user",content:`根据以下问题生成一个简短的标题（不超过15个字）："${e}"`}],temperature:.7,max_tokens:50})},H=await fetch(y.apiEndpoint,r);if(!H.ok)throw new Error(`标题生成API错误: ${H.status}`);let u=(C=(d=(o=(s=(await H.json()).choices)==null?void 0:s[0])==null?void 0:o.message)==null?void 0:d.content)==null?void 0:C.trim();u&&u.length>15&&(u=u.substring(0,15)+"..."),u=u.replace(/["']/g,""),m.value=u,console.log("生成的对话标题:",u),a.addHistory({id:p.value,title:u,timestamp:Date.now(),firstMessage:e})}catch(r){console.error("生成标题失败:",r);const H=e.length>10?e.substring(0,10)+"...":e;m.value=H,a.addHistory({id:p.value,title:H,timestamp:Date.now(),firstMessage:e})}},V=async e=>{var o,d,C;const s={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y.apiKey}`},body:JSON.stringify({model:y.model,messages:[{role:"user",content:e}],temperature:.7,max_tokens:800})};try{const r=await fetch(y.apiEndpoint,s);if(!r.ok){let u="";try{const K=await r.json();u=JSON.stringify(K)}catch{u="无法解析错误详情"}throw new Error(`API错误: ${r.status} ${r.statusText}. 详情: ${u}`)}const J=(C=(d=(o=(await r.json()).choices)==null?void 0:o[0])==null?void 0:d.message)==null?void 0:C.content;return J||"未能从API响应中获取到回答"}catch(r){throw(r.name==="AbortError"||r.message.includes("network")||r.message.includes("timeout"))&&(r.isNetworkError=!0),r}},b=async(e,s)=>{if((e.isNetworkError||e.message.includes("network")||e.message.includes("timeout"))&&k.value<ve){k.value++,n.value.push({type:"system",content:`网络请求失败，正在进行第${k.value}次重试...`,timestamp:Date.now()}),g(),D(()=>{I()}),await new Promise(o=>setTimeout(o,1e3)),t.value=!0;try{const o=await V(s);n.value=n.value.filter(d=>d.type!=="system"),n.value.push({type:"ai",content:O(o),timestamp:Date.now()}),g(),v.show=!1}catch(o){b(o,s)}finally{t.value=!1}}else{let o="抱歉，我暂时无法回答您的问题。",d="请求失败";e.isNetworkError||e.message.includes("network")?(d="网络连接错误",o+="请检查您的网络连接并稍后再试。"):e.message.includes("timeout")?(d="请求超时",o+="服务器响应时间过长，请稍后再试。"):e.message.includes("401")?(d="身份验证失败",o+="请联系管理员检查API密钥是否有效。"):e.message.includes("429")?(d="请求过于频繁",o+="已超过API使用限制，请稍后再试。"):e.message.includes("500")&&(d="服务器错误",o+="服务器内部错误，请稍后再试。");const C=`技术详情: ${e.message}`;v.title=d,v.message=`${o} (${C})`,v.show=!0,n.value.push({type:"ai",content:o,timestamp:Date.now(),isError:!0}),g()}},O=e=>e.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/\n/g,"<br>"),Y=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),I=()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)};return{userInput:S,isLoading:t,chatHistory:n,suggestedQuestions:P,errorInfo:v,showClearHistoryDialog:M,chatMessagesContainer:f,conversationTitle:m,Delete:de,ArrowUp:ce,Search:le,sendMessage:q,clearChatHistory:N,formatTime:Y,usePresetQuestion:e=>{S.value=e,q()}}}},ye={key:0,class:"conversation-title"},_e={class:"search-title"},we={key:0},ke={key:1},Ce={key:1,class:"chat-container"},He={class:"chat-messages",ref:"chatMessagesContainer"},Se={class:"message-content"},Ie={class:"message-avatar"},Ee={key:0},Te={key:1},De=["innerHTML"],Ae={class:"message-time"},Ne={key:2,class:"loading-indicator"},xe={key:3,class:"suggested-searches"},Me={class:"suggested-items"},Pe={class:"dialog-footer"};function Ve(A,a,S,t,n,M){const f=he,k=me("Right"),m=ge,p=se,v=pe,P=ae,y=ue;return c(),h("div",{class:B(["search-content",{"chat-history-active":t.chatHistory.length>0}])},[t.chatHistory.length>0&&t.conversationTitle?(c(),h("div",ye,x(t.conversationTitle),1)):E("",!0),l("div",_e,[t.conversationTitle?(c(),h("h1",ke,x(t.conversationTitle),1)):(c(),h("h1",we,"您想了解哪些林下经济知识？"))]),t.chatHistory.length>0?(c(),h("div",Ce,[l("div",He,[(c(!0),h(L,null,Q(t.chatHistory,(i,g)=>(c(),h("div",{key:g,class:B(["chat-message",i.type==="user"?"user-message":"ai-message"])},[l("div",Se,[l("div",Ie,[i.type==="user"?(c(),h("span",Ee,"👤")):(c(),h("span",Te,"🌳"))]),l("div",{class:"message-text",innerHTML:i.content},null,8,De)]),l("div",Ae,x(t.formatTime(i.timestamp)),1)],2))),128))],512)])):E("",!0),t.isLoading?(c(),h("div",Ne,a[4]||(a[4]=[l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-dot"},null,-1),l("span",{class:"loading-text"},"正在思考中...",-1)]))):E("",!0),l("div",{class:B(["search-container",{"search-minimized":t.chatHistory.length>0}])},[T(p,{modelValue:t.userInput,"onUpdate:modelValue":a[0]||(a[0]=i=>t.userInput=i),class:"search-input-el",placeholder:t.chatHistory.length>0?"继续提问...":"随意提问...",onKeyup:te(t.sendMessage,["enter"])},{append:_(()=>[T(f,{type:"primary",icon:t.chatHistory.length>0?"ArrowUp":"Search",onClick:t.sendMessage,disabled:t.isLoading||t.userInput.trim()===""},null,8,["icon","onClick","disabled"])]),suffix:_(()=>[t.userInput.trim().length>0?(c(),U(m,{key:0,class:"input-icon"},{default:_(()=>[T(k)]),_:1})):E("",!0)]),_:1},8,["modelValue","placeholder","onKeyup"])],2),t.chatHistory.length===0?(c(),h("div",xe,[a[5]||(a[5]=l("h3",null,"热门问题",-1)),l("div",Me,[(c(!0),h(L,null,Q(t.suggestedQuestions,(i,g)=>(c(),U(v,{key:g,class:"suggested-item-card",shadow:"hover",onClick:N=>t.usePresetQuestion(i)},{default:_(()=>[R(x(i),1)]),_:2},1032,["onClick"]))),128))])])):E("",!0),T(P,{modelValue:t.showClearHistoryDialog,"onUpdate:modelValue":a[2]||(a[2]=i=>t.showClearHistoryDialog=i),title:"清除历史记录",width:"30%","align-center":""},{footer:_(()=>[l("span",Pe,[T(f,{onClick:a[1]||(a[1]=i=>t.showClearHistoryDialog=!1)},{default:_(()=>a[6]||(a[6]=[R("取消")])),_:1}),T(f,{type:"danger",onClick:t.clearChatHistory},{default:_(()=>a[7]||(a[7]=[R("确定清除")])),_:1},8,["onClick"])])]),default:_(()=>[a[8]||(a[8]=l("span",null,"确定要清除所有聊天历史记录吗？此操作无法撤销。",-1))]),_:1},8,["modelValue"]),t.errorInfo.show?(c(),U(y,{key:4,title:t.errorInfo.title,description:t.errorInfo.message,type:"error","show-icon":"",class:"error-alert",onClose:a[3]||(a[3]=i=>t.errorInfo.show=!1)},null,8,["title","description"])):E("",!0),a[9]||(a[9]=ee('<div class="footer" data-v-ae867e7a><div class="footer-links" data-v-ae867e7a><a href="#" class="footer-link" data-v-ae867e7a>关于我们</a><a href="#" class="footer-link" data-v-ae867e7a>联系方式</a><a href="#" class="footer-link" data-v-ae867e7a>使用条款</a><a href="#" class="footer-link" data-v-ae867e7a>隐私政策</a></div><div class="copyright" data-v-ae867e7a> © 2025 林下经济研究中心 </div></div>',1))],2)}const Ue=$(fe,[["render",Ve],["__scopeId","data-v-ae867e7a"]]);export{Ue as default};
